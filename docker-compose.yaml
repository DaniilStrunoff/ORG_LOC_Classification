x-api-common: &api_common
  container_name: api
  build:
    context: .
    dockerfile: ./Dockerfile
  environment:
    POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
    POSTGRES_PORT: ${POSTGRES_PORT:-5432}
    POSTGRES_DB: ${POSTGRES_DB:-orgloc}
    POSTGRES_USER: ${POSTGRES_USER:-orgloc}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-orgloc}
    GRAFANA_URL: ${GRAFANA_URL:-http://grafana:3000}
    GRAFANA_TECH_USER_LOGIN: ${GRAFANA_TECH_USER_LOGIN:-tech}
    GRAFANA_TECH_USER_PASSWORD: ${GRAFANA_TECH_USER_PASSWORD:-supersecret}
    GRAFANA_DS_UID: ${GRAFANA_DS_UID:-postgres_main}
    MODEL_STORE_ROOT: ${MODEL_STORE_ROOT:-/artifacts/models}
    HF_HUB_CACHE: ${HF_HUB_CACHE:-/artifacts/hf_cache}
    HF_TOKEN: ${HF_TOKEN}
    HUGGINGFACE_HUB_TOKEN: ${HUGGINGFACE_HUB_TOKEN:-${HF_TOKEN}}
  deploy:
    resources:
      reservations:
        devices:
          - capabilities: [gpu]
  runtime: ${RUNTIME:-nvidia}


services:
  postgres:
    container_name: postgres
    image: postgres:16
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-orgloc}
      POSTGRES_USER: ${POSTGRES_USER:-orgloc}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-orgloc}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./database/initialization:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 30

  grafana:
    container_name: grafana
    image: grafana/grafana:10.4.2
    environment:
      GRAFANA_PORT: ${GRAFANA_PORT:-3000}
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_DEFAULT_USER:-admin_us}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_DEFAULT_PASSWORD:-admin}
      GRAFANA_TECH_USER_LOGIN: ${GRAFANA_TECH_USER_LOGIN:-tech}
      GRAFANA_TECH_USER_PASSWORD: ${GRAFANA_TECH_USER_PASSWORD:-supersecret}
      GRAFANA_TECH_USER_NAME: ${GRAFANA_TECH_USER_NAME:-Tech_User}
      GRAFANA_TECH_USER_ROLE: ${GRAFANA_TECH_USER_ROLE:-Admin}
      GF_AUTH_DISABLE_LOGIN_FORM: ${GRAFANA_AUTH_DISABLE_LOGIN_FORM:-true}
      GF_AUTH_ANONYMOUS_ENABLED: ${GRAFANA_AUTH_ANONYMOUS_ENABLED:-true}
      GF_AUTH_ANONYMOUS_ORG_ROLE: ${GRAFANA_AUTH_ANONYMOUS_ORG_ROLE:-Admin}
      GRAFANA_DS_UID: ${GRAFANA_DS_UID:-postgres_main}
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-orgloc}
      POSTGRES_DB: ${POSTGRES_DB:-orgloc}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-orgloc}
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./dashboard/datasources:/etc/grafana/provisioning/datasources:ro
      - ./dashboard/grafana/initialization/grafana-init.sh:/usr/local/bin/grafana-init.sh:ro
    depends_on:
      postgres:
        condition: service_healthy
    entrypoint: ["/bin/sh","/usr/local/bin/grafana-init.sh"]
    restart: "no"
    healthcheck:
      test: ["CMD-SHELL","wget -qO- http://127.0.0.1:3000/api/health >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30

  api:
    <<: *api_common
    container_name: api
    depends_on:
      postgres:
        condition: service_healthy
      grafana:
        condition: service_healthy
    ports:
      - "${API_PUBLISH_PORT:-8000}:8000"
    command: >
      bash -lc "python -u -m src.bootstrap.bootstrap_gpu || echo 'bootstrap_gpu: skipped';
                exec uvicorn src.api.api:app --host 0.0.0.0 --port 8000"
    volumes:
      - venv-cache:/opt/venv
      - ./src:/app/src:rw
      - .${MODEL_STORE_ROOT:-/artifacts/models}:${MODEL_STORE_ROOT:-/artifacts/models}:rw
      - .${HF_HUB_CACHE:-/artifacts/hf_cache}:${HF_HUB_CACHE:-/artifacts/hf_cache}:rw

volumes:
  pg_data: {}
  grafana_data: {}
  venv-cache: {}
